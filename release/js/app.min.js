(function (angular) {
	'use strict';

	var app = angular.module('ng');

	app.factory({

		SessionService: [
			function () {
				var ref = new Firebase('https://barcamp.firebaseio.com/Sessions/'),
				// object to store all references
				sessionRef = {};

				// Returns the Firebase reference for given Session ID
				function createReference (id) {
					if (!sessionRef.hasOwnProperty(id)) {
						sessionRef[id] = ref.child(id);
					}
					return sessionRef[id];
				}

				return {
					list: function () {},

					increaseVote: function (session) {
						var childRef = createReference(session.id);
						childRef.transaction(function (data) {
							data.total_votes += 1;
							return data;
						});
					},

					decreaseVote: function (session) {
						var childRef = createReference(session.id);
						childRef.transaction(function (data) {
							data.total_votes -= 1;
							return data;
						});
					}
				};
			}
		],

		AuthService: [
			function () {
				var barcampRef = new Firebase('https://barcamp.firebaseio.com/');

				function signIn (id) {
					var auth,
						validId = true;
					if (validId) {
						auth = new FirebaseSimpleLogin(barcampRef, function (err, user) {
							if (err) {
								console.log(err);
							} else {
								return user;
							}
						});
					}
					return auth;
				}

				return {
					login: function (id) {
						var auth = signIn(id);
						auth.login('anonymous');
					},

					logout: function () {}
				};
			}
		]
	});
}(window.angular));




(function (angular) {
	'use strict';

	var app = angular.module('ng');

	app.controller({

		BarcampController: function ($scope, angularFireAuth) {},

		SigninController: function ($scope, AuthService, $location) {
			var ref = new Firebase('https://barcamp.firebaseio.com/');

			$scope.authCallback = function (error, user) {
				if (error) {
					console.log('error: ' + error.code);
				} else if (user) {
					localStorage.setItem('token', user.firebaseAuthToken);
					$scope.isLoggedIn = true;
					$scope.userid = user.id;

					$scope.userRef = ref.child('Users').child(id);
					$scope.userRef.once('value', function (data) {
						var val = data.val();
						var info = {
							userId: user.id,
							valid: data.valid
						};
						if (val) {
							info = val;
						}
						$scope.userRef.set(info);

						$location.path('/sessions');
					});
				} else {
					localStorage.clear();
					$scope.isLoggedIn = false;
					$location.path('/');
				}
			};

			$scope.login = function(provider) {
				$scope.token = localStorage.getItem('token');
				var options = {
					'rememberMe': true
				};
				provider = 'anonymous';

				if ($scope.token) {
					console.log('login with token', $scope.token);
					fireFactory.firebaseRef('users').auth($scope.token, $scope.authCallback);
				} else {
					console.log('login with authClient');
					authClient.login(provider, options);
				}
			};

			$scope.logout = function() {
				localStorage.clear();
				authClient.logout();
				$location.path('/');
			};
		},

		ResultsController: function($scope, angularFire) {

			var ref = new Firebase('https://barcamp.firebaseio.com/Sessions');

			$scope.sessions = angularFire(ref, $scope, 'sessions');
			$scope.gridOptions = {
					data: 'sessions' ,
					enableColumnResize: true,
					enableRowSelection: true,
					multiSelect: false,
					enableColumnReordering: true,
					enableCellEditOnFocus: true,
					// Sorting syntax does not work :( -Bill Butler
					//sortInfo: { fields: ['total_votes'], direction: 'desc' },
					//showColumnMenu: true,
					//showFilter: true,
					columnDefs: [{field: 'id', displayName: 'ID', enableCellEdit: false, width: '10%'},
								{field: 'Title', displayName: 'Title', enableCellEdit: false, width: '30%'},
								{field: "Username", displayName: 'Username', enableCellEdit: false, width: '10%'},
								{field: 'Room', displayName:'Room', enableCellEdit: true, width: '8%'},
								{field: 'Time', displayName:'Time', enableCellEdit: true, width: '8%'},
								{field: 'Availability', displayName:'Availability', enableCellEdit: true, width: '24%'},
								{field: 'total_votes', displayName:'Votes', enableCellEdit: false, width: '10%'}]
					};
		},

		SessionListingController: function ($scope, $location) {

			$scope.votesRemaining = 4;
			$scope.mysessionlist = [];

			var SessionsRef = new Firebase('https://barcamp.firebaseio.com/Sessions');
			SessionsRef.once('value', function (snapshot) {
				$scope.$apply(function () {
					$scope.sessions = snapshot.val();
				});
			});

			$scope.sessionFilter = {
				Availability: 'Morning'
			};

			$scope.$on('upVote', function () {
				$scope.votesRemaining -= 1;
			});

			$scope.$on('downVote', function () {
				$scope.votesRemaining += 1;
			});
		},

		SessionDetailController: function($scope, $location) {
			$scope.sessionId = $routeParams.sessionId;
		},

		SessionController: function ($scope, SessionService) {
			$scope.votes = {voted: false};

			$scope.upVote = function (session) {
				if ($scope.votesRemaining === 0) {
					return;
				}
				// $scope.mysessionlist.push(session);
				$scope.votes.voted = true;
				$scope.$emit('upVote');
				SessionService.increaseVote(session);

			};

			$scope.downVote = function (session) {
				if ($scope.votesRemaining > 4) {
					return;
				}
				// $scope.mysessionlist.splice($scope.mysessionlist.indexOf(session), 1);
				$scope.votes.voted = false;
				$scope.$emit('downVote');
				SessionService.decreaseVote(session);
			};
		}
	});

}(window.angular));

(function (angular) {
	'use strict';

	var app = angular.module('BarcampApp',['ngRoute','firebase','ngGrid', 'truncate']);

	app.config([
		'$routeProvider',
		function ($routeProvider) {
			$routeProvider
				.when('/', {
					templateUrl : '/templates/signin.html',
					controller : 'SigninController'
				})
				.when('/results', {
					templateUrl : '/templates/results.html',
					controller : 'ResultsController'
				})
				.when('/sessions', {
					templateUrl: '/templates/sessionlist.html',
					controller: 'SessionListingController'
				}).
				when('/sessions/:sessionId', {
					templateUrl: 'templates/sessiondetail.html',
					controller: 'SessionDetailController'
				});
		}
	]);

	//source: https://github.com/sparkalow/angular-truncate
	angular.module('truncate', [])
    .filter('characters', function () {
        return function (input, chars, breakOnWord) {
            if (isNaN(chars)) return input;
            if (chars <= 0) return '';
            if (input && input.length >= chars) {
                input = input.substring(0, chars);

                if (!breakOnWord) {
                    var lastspace = input.lastIndexOf(' ');
                    //get last space
                    if (lastspace !== -1) {
                        input = input.substr(0, lastspace);
                    }
                }else{
                    while(input.charAt(input.length-1) == ' '){
                        input = input.substr(0, input.length -1);
                    }
                }
                return input + '...';
            }
            return input;
        };
    })
    .filter('words', function () {
        return function (input, words) {
            if (isNaN(words)) return input;
            if (words <= 0) return '';
            if (input) {
                var inputWords = input.split(/\s+/);
                if (inputWords.length > words) {
                    input = inputWords.slice(0, words).join(' ') + '...';
                }
            }
            return input;
        };
    });
}(window.angular));